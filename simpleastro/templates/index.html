<!DOCTYPE html>
<html lang="en">
<head>
    <title>Birth Chart Generator</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .form-group { margin-bottom: 10px; }
        #chart-container { margin-top: 30px; width: 100%; max-width: 800px; }
        /* Spinner */
        .spinner { display: inline-block; width: 18px; height: 18px; border: 3px solid rgba(0,0,0,0.1); border-top-color: #333; border-radius: 50%; animation: spin 1s linear infinite; vertical-align: middle; margin-left: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
<h1>Natal Chart Generator</h1>
<form id="birth-form" action="/submit" method="POST">
    <div class="form-group">
        <input name="name" placeholder="Name" required>
    </div>
    <div class="form-group">
        <input name="year" type="number" placeholder="Year (YYYY)" required>
        <input name="month" type="number" placeholder="Month (MM)" required>
        <input name="day" type="number" placeholder="Day (DD)" required>
    </div>
    <div class="form-group">
        <input name="hour" type="number" placeholder="Hour (0-23)" required>
        <input name="minute" type="number" placeholder="Minute" required>
    </div>
    <div class="form-group">
        <input name="city" placeholder="City" required>
        <input name="region" placeholder="State/Province/Region">

        <input list="country-list" id="country-input" name="country_name" placeholder="Start typing country..." required>
        <input type="hidden" name="country" id="country-code">
        <datalist id="country-list"></datalist>
    </div>

    <button id="submit-btn" type="submit">Display Chart</button>
    <span id="spinner" style="display:none" aria-hidden="true" class="spinner"></span>
</form>

<div id="chart-container">
    {% if chart_svg %}
    {{ chart_svg }}
    {% endif %}
</div>

<script>
    (function() {
        const countryList = document.getElementById('country-list');
        const countryInput = document.getElementById('country-input');
        const countryCodeHidden = document.getElementById('country-code');
        const submitBtn = document.getElementById('submit-btn');
        const spinner = document.getElementById('spinner');
        let countriesData = [];

        fetch('https://restcountries.com/v3.1/all?fields=name,cca2')
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok: ' + response.status);
            return response.json();
        })
        .then(data => {
            countriesData = data.sort((a, b) => a.name.common.localeCompare(b.name.common));
            countriesData.forEach(country => {
                const option = document.createElement('option');
                option.value = country.name.common;
                countryList.appendChild(option);
            });
        })
        .catch(err => {
            console.error('Failed to load country list:', err);
            const fallback = [
                { name: { common: 'United States' }, cca2: 'US' },
                { name: { common: 'United Kingdom' }, cca2: 'GB' },
                { name: { common: 'Canada' }, cca2: 'CA' },
                { name: { common: 'Australia' }, cca2: 'AU' }
            ];
            countriesData = fallback;
            fallback.forEach(country => {
                const option = document.createElement('option');
                option.value = country.name.common;
                countryList.appendChild(option);
            });
        });

        countryInput.addEventListener('input', () => {
            const selected = countriesData.find(c => c.name && c.name.common === countryInput.value);
            if (selected) {
                countryCodeHidden.value = selected.cca2;
            } else {
                countryCodeHidden.value = '';
            }
        });

        const form = document.getElementById('birth-form');
        form.addEventListener('submit', async (ev) => {
            ev.preventDefault(); // we'll submit via fetch

            // ensure hidden code is set
            if (!countryCodeHidden.value && countryInput.value) {
                const selected = countriesData.find(c => c.name && c.name.common === countryInput.value);
                if (selected) countryCodeHidden.value = selected.cca2;
            }

            submitBtn.disabled = true;
            spinner.style.display = 'inline-block';
            submitBtn.textContent = 'Generating...';

            const formData = new FormData(form);
            try {
                const resp = await fetch(form.action, { method: 'POST', body: formData });
                if (!resp.ok) throw new Error('Server returned ' + resp.status);
                const body = await resp.json();
                // Redirect to status page
                window.location = body.status_url;
            } catch (err) {
                console.error('Submit failed', err);
                alert('Failed to start chart generation: ' + err.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Display Chart';
                spinner.style.display = 'none';
            }
        });
    })();
</script>
</body>
</html>
